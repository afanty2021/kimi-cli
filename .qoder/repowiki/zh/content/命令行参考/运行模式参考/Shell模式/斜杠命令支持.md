# 斜杠命令支持

<cite>
**本文档中引用的文件**   
- [slash.py](file://src/kimi_cli/soul/slash.py)
- [slash.py](file://src/kimi_cli/ui/shell/slash.py)
- [slashcmd.py](file://src/kimi_cli/utils/slashcmd.py)
- [__init__.py](file://src/kimi_cli/ui/shell/__init__.py)
- [kimisoul.py](file://src/kimi_cli/soul/kimisoul.py)
- [test_slash_command.py](file://tests/test_slash_command.py)
</cite>

## 目录
1. [简介](#简介)
2. [斜杠命令系统架构](#斜杠命令系统架构)
3. [核心组件分析](#核心组件分析)
4. [斜杠命令注册与解析](#斜杠命令注册与解析)
5. [斜杠命令执行流程](#斜杠命令执行流程)
6. [测试与验证](#测试与验证)
7. [结论](#结论)

## 简介
Kimi CLI 提供了一套完整的斜杠命令（Slash Commands）系统，允许用户通过以 `/` 开头的特殊命令与应用程序进行交互。这些命令分为两个层级：Shell 级和 Soul 级，提供了丰富的功能来控制应用程序行为、获取信息和执行特定操作。

## 斜杠命令系统架构

```mermaid
graph TD
A[用户输入] --> B{是否以/开头?}
B --> |是| C[解析斜杠命令]
B --> |否| D[作为普通消息处理]
C --> E{命令是否存在?}
E --> |否| F[显示未知命令错误]
E --> |是| G{Shell级命令?}
G --> |是| H[执行Shell级命令]
G --> |否| I[执行Soul级命令]
H --> J[命令执行完成]
I --> K[命令执行完成]
J --> L[继续等待输入]
K --> L
```

**图表来源**
- [__init__.py](file://src/kimi_cli/ui/shell/__init__.py#L99-L101)
- [slash.py](file://src/kimi_cli/ui/shell/slash.py#L30)
- [slash.py](file://src/kimi_cli/soul/slash.py#L29)

## 核心组件分析

### 斜杠命令注册器
斜杠命令系统的核心是 `SlashCommandRegistry` 类，它负责管理所有可用的斜杠命令。该注册器使用装饰器模式来注册命令，并支持命令别名。

```mermaid
classDiagram
class SlashCommandRegistry {
+_commands : dict[str, SlashCommand]
+_command_aliases : dict[str, SlashCommand]
+command(func) : decorator
+find_command(name) : SlashCommand | None
+list_commands() : list[SlashCommand]
}
class SlashCommand {
+name : str
+description : str
+func : Callable
+aliases : list[str]
+slash_name() : str
}
SlashCommandRegistry --> SlashCommand : 包含
```

**图表来源**
- [slashcmd.py](file://src/kimi_cli/utils/slashcmd.py#L22-L94)

### 命令调用数据结构
`SlashCommandCall` 类用于表示一个斜杠命令调用，包含命令名称、参数和原始输入。

```mermaid
classDiagram
class SlashCommandCall {
+name : str
+args : list[str]
+raw_input : str
}
```

**图表来源**
- [slashcmd.py](file://src/kimi_cli/utils/slashcmd.py#L98-L102)

## 斜杠命令注册与解析

### 命令注册机制
斜杠命令通过装饰器进行注册，支持自定义名称和别名。注册器会同时维护主命令名称和所有别名的映射。

```mermaid
sequenceDiagram
participant 用户 as 用户
participant 装饰器 as @registry.command
participant 注册器 as SlashCommandRegistry
participant 命令列表 as _commands
participant 别名列表 as _command_aliases
用户->>装饰器 : 定义命令函数
装饰器->>注册器 : 调用 _register()
注册器->>注册器 : 提取函数名称/自定义名称
注册器->>注册器 : 获取函数文档作为描述
注册器->>命令列表 : 存储主命令
注册器->>别名列表 : 存储主命令
loop 每个别名
注册器->>别名列表 : 存储别名映射
end
注册器-->>装饰器 : 返回原函数
装饰器-->>用户 : 命令注册完成
```

**图表来源**
- [slashcmd.py](file://src/kimi_cli/utils/slashcmd.py#L42-L87)
- [slash.py](file://src/kimi_cli/ui/shell/slash.py#L39)
- [slash.py](file://src/kimi_cli/soul/slash.py#L32)

### 命令解析流程
当用户输入以 `/` 开头时，系统会解析该输入以确定是否为有效的斜杠命令。

```mermaid
flowchart TD
Start([开始]) --> Strip["去除首尾空白"]
Strip --> StartWith["检查是否以/开头"]
StartWith --> |否| ReturnNone["返回 None"]
StartWith --> |是| Split["使用 shlex.split 分割"]
Split --> |ValueError| ReturnNone
Split --> Match["正则匹配命令名称"]
Match --> |不匹配| ReturnNone
Match --> |匹配| Extract["提取命令名称"]
Extract --> Create["创建 SlashCommandCall 对象"]
Create --> ReturnCall["返回命令调用对象"]
ReturnNone --> End([结束])
ReturnCall --> End
```

**图表来源**
- [slashcmd.py](file://src/kimi_cli/utils/slashcmd.py#L104-L126)
- [test_slash_command.py](file://tests/test_slash_command.py#L40-L88)

## 斜杠命令执行流程

### Shell 级命令执行
Shell 级命令由 UI 层直接处理，通常用于控制界面行为或获取系统信息。

```mermaid
sequenceDiagram
participant Shell as Shell
participant Parser as parse_slash_command_call
participant Registry as shell_slash_registry
participant Command as SlashCommand
participant Console as console
Shell->>Parser : 解析用户输入
Parser-->>Shell : 返回 SlashCommandCall
Shell->>Registry : find_command(name)
Registry-->>Shell : 返回 Command 或 None
alt 命令不存在
Shell->>Console : 显示未知命令错误
else Shell级命令
Shell->>Command : 调用 func(Shell, args)
Command-->>Shell : 返回结果
else Soul级命令
Shell->>Shell : _run_soul_command(raw_input)
end
Shell-->>用户 : 命令执行完成
```

**图表来源**
- [__init__.py](file://src/kimi_cli/ui/shell/__init__.py#L146-L179)
- [slash.py](file://src/kimi_cli/ui/shell/slash.py)

### Soul 级命令执行
Soul 级命令由核心逻辑层处理，通常用于执行与 AI 代理相关的操作。

```mermaid
sequenceDiagram
participant KimiSoul as KimiSoul
participant Parser as parse_slash_command_call
participant Registry as soul_slash_registry
participant Command as SlashCommand
KimiSoul->>Parser : 解析用户输入
Parser-->>KimiSoul : 返回 SlashCommandCall
KimiSoul->>Registry : find_command(name)
Registry-->>KimiSoul : 返回 Command
KimiSoul->>Command : 调用 func(KimiSoul, args)
Command-->>KimiSoul : 返回结果
KimiSoul-->>用户 : 命令执行完成
```

**图表来源**
- [kimisoul.py](file://src/kimi_cli/soul/kimisoul.py#L165-L179)
- [slash.py](file://src/kimi_cli/soul/slash.py)

## 测试与验证

### 命令解析测试
系统提供了全面的测试用例来验证斜杠命令解析的正确性，包括各种边界情况。

```mermaid
flowchart TD
TestCases["测试用例"] --> Regular["常规情况"]
TestCases --> Edge["边界情况"]
TestCases --> Invalid["无效情况"]
Regular --> SlashHelp["/help"]
Regular --> SlashSearch["/search query"]
Edge --> DoubleSlash["//comment"]
Edge --> Comments["/* comment */ 和 # comment"]
Edge --> ChineseArgs["/echo 你好世界"]
Invalid --> Empty["空输入"]
Invalid --> NoSlash["help (无斜杠)"]
Invalid --> Malformed["/cmd \"unmatched quote\""]
style Regular fill:#9f9,stroke:#333
style Edge fill:#ff9,stroke:#333
style Invalid fill:#f99,stroke:#333
```

**图表来源**
- [test_slash_command.py](file://tests/test_slash_command.py#L40-L88)

### 命令注册测试
测试验证了命令注册的各种场景，包括别名、自定义名称和覆盖行为。

```mermaid
classDiagram
class TestRegistry {
+test_slash_command_registration()
+test_slash_command_overwriting()
}
class SlashCommandRegistry {
+command()
+find_command()
+list_commands()
}
TestRegistry --> SlashCommandRegistry : 使用
```

**图表来源**
- [test_slash_command.py](file://tests/test_slash_command.py#L100-L192)

## 结论
Kimi CLI 的斜杠命令系统设计精巧，具有以下特点：
- **分层架构**：区分 Shell 级和 Soul 级命令，实现关注点分离
- **灵活注册**：通过装饰器模式支持命令注册，可自定义名称和别名
- **健壮解析**：使用 shlex 和正则表达式确保命令解析的准确性
- **完整测试**：提供全面的测试用例覆盖各种使用场景
- **用户友好**：支持中文参数，提供清晰的错误提示

该系统为用户提供了强大的交互能力，同时保持了代码的可维护性和扩展性。