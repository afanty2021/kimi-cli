# 文件操作工具

<cite>
**本文档中引用的文件**  
- [read.py](file://src/kimi_cli/tools/file/read.py)
- [write.py](file://src/kimi_cli/tools/file/write.py)
- [replace.py](file://src/kimi_cli/tools/file/replace.py)
- [glob.py](file://src/kimi_cli/tools/file/glob.py)
- [grep.py](file://src/kimi_cli/tools/file/grep.py)
- [patch.py](file://src/kimi_cli/tools/file/patch.py)
- [read.md](file://src/kimi_cli/tools/file/read.md)
- [write.md](file://src/kimi_cli/tools/file/write.md)
- [replace.md](file://src/kimi_cli/tools/file/replace.md)
- [glob.md](file://src/kimi_cli/tools/file/glob.md)
- [grep.md](file://src/kimi_cli/tools/file/grep.md)
- [patch.md](file://src/kimi_cli/tools/file/patch.md)
- [test_read_file.py](file://tests/test_read_file.py)
- [test_write_file.py](file://tests/test_write_file.py)
- [test_str_replace_file.py](file://tests/test_str_replace_file.py)
- [test_glob.py](file://tests/test_glob.py)
- [test_grep.py](file://tests/test_grep.py)
- [test_patch_file.py](file://tests/test_patch_file.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心工具详解](#核心工具详解)
   1. [ReadFile - 文件读取](#readfile---文件读取)
   2. [WriteFile - 文件写入](#writefile---文件写入)
   3. [StrReplaceFile - 字符串替换](#strreplacefile---字符串替换)
   4. [Glob - 路径匹配](#glob---路径匹配)
   5. [Grep - 文本搜索](#grep---文本搜索)
   6. [PatchFile - 补丁应用](#patchfile---补丁应用)
3. [安全审批机制](#安全审批机制)
4. [使用限制与最佳实践](#使用限制与最佳实践)
5. [工具协作场景](#工具协作场景)
6. [实际调用示例](#实际调用示例)
7. [总结](#总结)

## 简介

本文档详细介绍了kimi-cli项目中的六个核心文件操作工具：ReadFile、WriteFile、StrReplaceFile、Glob、Grep和PatchFile。这些工具为自动化文件操作提供了强大而安全的功能，涵盖了从文件读取、写入、内容搜索到批量处理的完整工作流。每个工具都经过精心设计，具有明确的功能定位、参数规范和异常处理机制，同时集成了安全审批流程以防止意外的文件修改。通过这些工具的组合使用，可以高效地完成复杂的文件操作任务。

## 核心工具详解

### ReadFile - 文件读取

ReadFile工具用于读取文本文件的内容。它支持从指定行号开始读取，并可限制读取的行数，这对于处理大型文件非常有用。

**功能定位**：读取文件内容，支持分段读取和内容截断。

**输入参数**：
- `path`：要读取的文件的绝对路径。
- `line_offset`：开始读取的行号（从1开始），默认从文件开头读取。
- `n_lines`：要读取的行数，默认最多读取1000行。

**返回结构**：成功时返回包含文件内容的ToolOk对象，内容以`cat -n`格式显示（每行前有行号）；失败时返回ToolError对象。

**异常处理**：
- 路径不是绝对路径时返回错误。
- 文件不存在或路径指向目录时返回错误。
- 单行长度超过2000字符时会被截断。
- 读取内容总大小超过100KB或行数超过1000行时会提前终止。

**使用限制**：
- 仅能读取文本文件。
- 单次读取最多1000行或100KB内容。
- 行长度超过2000字符会被截断。

**Section sources**
- [read.py](file://src/kimi_cli/tools/file/read.py#L1-L141)
- [read.md](file://src/kimi_cli/tools/file/read.md#L1-L15)
- [test_read_file.py](file://tests/test_read_file.py#L1-L315)

### WriteFile - 文件写入

WriteFile工具用于创建新文件或向现有文件写入内容，支持覆盖写入和追加写入两种模式。

**功能定位**：写入或创建文件，支持覆盖和追加模式。

**输入参数**：
- `path`：要写入的文件的绝对路径。
- `content`：要写入文件的内容。
- `mode`：写入模式，可选"overwrite"（覆盖）或"append"（追加），默认为"overwrite"。

**返回结构**：成功时返回ToolOk对象，包含操作成功消息；失败时返回ToolError对象。

**异常处理**：
- 路径不是绝对路径时返回错误。
- 路径超出工作目录范围时返回错误。
- 目标文件的父目录不存在时返回错误。
- 模式参数无效时返回错误。

**安全审批**：所有写入操作都需要通过Approval机制的审批。

**使用限制**：
- 只能在工作目录内创建或修改文件。
- 内容编码为UTF-8。
- 需要用户明确批准写入操作。

**Section sources**
- [write.py](file://src/kimi_cli/tools/file/write.py#L1-L120)
- [write.md](file://src/kimi_cli/tools/file/write.md#L1-L6)
- [test_write_file.py](file://tests/test_write_file.py#L1-L162)

### StrReplaceFile - 字符串替换

StrReplaceFile工具用于在指定文件中进行字符串替换，支持单次替换、全局替换和多组替换。

**功能定位**：在文件中替换特定字符串，支持多行字符串和批量替换。

**输入参数**：
- `path`：要编辑的文件的绝对路径。
- `edit`：替换操作，可以是单个Edit对象或Edit对象列表。
  - `old`：要替换的旧字符串（可多行）。
  - `new`：替换后的新字符串（可多行）。
  - `replace_all`：是否替换所有匹配项，默认为False。

**返回结构**：成功时返回ToolOk对象，包含替换统计信息；失败时返回ToolError对象。

**异常处理**：
- 路径不是绝对路径或超出工作目录范围时返回错误。
- 文件不存在或路径指向目录时返回错误。
- 替换未找到匹配项时返回错误。

**安全审批**：所有替换操作都需要通过Approval机制的审批。

**使用限制**：
- 只能在工作目录内的文件上执行。
- 仅适用于文本文件。
- 需要用户明确批准替换操作。

**Section sources**
- [replace.py](file://src/kimi_cli/tools/file/replace.py#L1-L145)
- [replace.md](file://src/kimi_cli/tools/file/replace.md#L1-L8)
- [test_str_replace_file.py](file://tests/test_str_replace_file.py#L1-L218)

### Glob - 路径匹配

Glob工具用于根据glob模式查找文件和目录，支持标准的通配符语法。

**功能定位**：使用glob模式匹配文件和目录路径。

**输入参数**：
- `pattern`：用于匹配文件/目录的glob模式。
- `directory`：要搜索的目录的绝对路径，默认为工作目录。
- `include_dirs`：是否在结果中包含目录，默认为True。

**返回结构**：成功时返回ToolOk对象，输出匹配的路径列表；失败时返回ToolError对象。

**异常处理**：
- 模式以"**"开头时返回错误（防止递归搜索过大范围）。
- 目录路径不是绝对路径或超出工作目录范围时返回错误。
- 目录不存在或路径不是目录时返回错误。

**使用限制**：
- 模式不能以"**"开头，以防止过度递归搜索。
- 最多返回1000个匹配结果。
- 只能在工作目录内搜索。

**Section sources**
- [glob.py](file://src/kimi_cli/tools/file/glob.py#L1-L150)
- [glob.md](file://src/kimi_cli/tools/file/glob.md#L1-L18)
- [test_glob.py](file://tests/test_glob.py#L1-L323)

### Grep - 文本搜索

Grep工具基于ripgrep实现，用于在文件内容中搜索正则表达式模式，功能强大且高效。

**功能定位**：在文件内容中搜索正则表达式模式。

**输入参数**：
- `pattern`：要在文件内容中搜索的正则表达式模式。
- `path`：要搜索的文件或目录，默认为当前工作目录。
- `glob`：用于过滤文件的glob模式。
- `output_mode`：输出模式，可选"content"（显示匹配行）、"files_with_matches"（显示匹配文件路径）或"count_matches"（显示匹配计数）。
- `before_context` (-B)：显示匹配行前的上下文行数。
- `after_context` (-A)：显示匹配行后的上下文行数。
- `context` (-C)：显示匹配行前后各N行的上下文。
- `line_number` (-n)：是否显示行号。
- `ignore_case` (-i)：是否忽略大小写。
- `type`：文件类型过滤器。
- `head_limit`：限制输出行数。
- `multiline`：是否启用多行模式。

**返回结构**：成功时返回ToolOk对象，包含搜索结果；失败时返回ToolError对象。

**使用限制**：
- 底层使用ripgrep，支持其完整的正则表达式语法。
- 搜索结果可被head_limit参数限制。
- 支持多种输出格式和上下文显示。

**Section sources**
- [grep.py](file://src/kimi_cli/tools/file/grep.py#L1-L303)
- [grep.md](file://src/kimi_cli/tools/file/grep.md#L1-L6)
- [test_grep.py](file://tests/test_grep.py#L1-L370)

### PatchFile - 补丁应用

PatchFile工具用于将统一格式的diff补丁应用到文件，实现精确的文件修改。

**功能定位**：将diff补丁应用到文件。

**输入参数**：
- `path`：要应用补丁的文件的绝对路径。
- `diff`：以统一格式表示的diff内容。

**返回结构**：成功时返回ToolOk对象，包含应用的hunk数量；失败时返回ToolError对象。

**异常处理**：
- 路径不是绝对路径或超出工作目录范围时返回错误。
- 文件不存在或路径指向目录时返回错误。
- diff格式无效或不包含有效hunk时返回错误。
- 补丁无法干净应用时返回错误。

**安全审批**：所有补丁应用操作都需要通过Approval机制的审批。

**使用限制**：
- 补丁必须是统一diff格式（如`diff -u`或`git diff`输出）。
- 仅适用于文本文件。
- 需要用户明确批准补丁应用操作。

**Section sources**
- [patch.py](file://src/kimi_cli/tools/file/patch.py#L1-L174)
- [patch.md](file://src/kimi_cli/tools/file/patch.md#L1-L9)
- [test_patch_file.py](file://tests/test_patch_file.py#L1-L209)

## 安全审批机制

所有可能修改文件的工具（WriteFile、StrReplaceFile、PatchFile）都集成了安全审批机制，这是防止意外文件修改的关键保护措施。

**审批流程**：
1. 当调用写入、替换或补丁工具时，系统会自动触发审批请求。
2. 用户必须明确批准该操作才能继续执行。
3. 如果用户拒绝，工具将返回ToolRejectedError，操作被取消。

**设计目的**：
- 防止自动化脚本意外修改重要文件。
- 确保用户对所有文件修改操作有完全的知情权和控制权。
- 提供额外的安全层，特别是在处理关键配置文件或源代码时。

**实现方式**：
- 通过Approval类实现，作为工具的依赖注入。
- 在工具的`__call__`方法中调用`approval.request()`进行审批。
- 审批信息包括工具名称、操作类型和具体描述。

这种机制确保了即使在复杂的自动化流程中，关键的文件修改操作也始终在用户的监督和控制之下。

**Section sources**
- [write.py](file://src/kimi_cli/tools/file/write.py#L8-L11)
- [replace.py](file://src/kimi_cli/tools/file/replace.py#L8-L11)
- [patch.py](file://src/kimi_cli/tools/file/patch.py#L9-L11)
- [approval.py](file://src/kimi_cli/soul/approval.py)

## 使用限制与最佳实践

### 文件大小与编码限制
- **读取限制**：ReadFile工具单次最多读取1000行或100KB内容，单行最多2000字符。
- **编码格式**：所有工具默认使用UTF-8编码处理文本文件。
- **二进制文件**：这些工具仅适用于文本文件，不支持二进制文件操作。

### 性能与效率最佳实践
- **批量读取**：使用ReadFile时，尽量一次性读取所需内容，避免多次小量读取。
- **大文件处理**：对于大文件，使用`line_offset`和`n_lines`参数分段读取。
- **搜索优化**：使用Grep时，结合`glob`或`type`参数缩小搜索范围，提高效率。
- **长内容写入**：对于超过100行的长内容，先用"overwrite"模式写入第一部分，再用"append"模式追加后续部分。

### 安全性最佳实践
- **路径安全**：始终使用绝对路径，并确保路径在工作目录范围内。
- **审批确认**：认真审查所有需要审批的文件修改操作。
- **模式安全**：避免使用过于宽泛的glob模式（如`**/*.py`），以防止意外匹配。

**Section sources**
- [read.py](file://src/kimi_cli/tools/file/read.py#L11-L13)
- [glob.py](file://src/kimi_cli/tools/file/glob.py#L14)
- [write.md](file://src/kimi_cli/tools/file/write.md#L5)

## 工具协作场景

这些文件操作工具可以协同工作，形成强大的文件处理流水线。

### 典型协作流程
1. **查找-搜索-修改**：
   - 使用Glob查找特定类型的文件（如`*.py`）。
   - 使用Grep在这些文件中搜索特定内容模式。
   - 使用StrReplaceFile或PatchFile对匹配的文件进行修改。

2. **读取-分析-写入**：
   - 使用ReadFile读取配置文件内容。
   - 分析内容并生成新的配置。
   - 使用WriteFile将新配置写回文件。

3. **批量处理**：
   - 使用Glob找到一批需要处理的文件。
   - 对每个文件使用ReadFile读取内容。
   - 进行必要的修改后，使用WriteFile保存更改。

### 协作优势
- **模块化**：每个工具职责单一，易于组合和复用。
- **安全性**：每个修改操作都经过独立的审批流程。
- **效率**：可以并行执行多个读取操作，提高整体处理速度。

这种工具间的协作使得复杂的文件操作任务可以被分解为简单、安全、可管理的步骤。

**Section sources**
- [glob.py](file://src/kimi_cli/tools/file/glob.py)
- [grep.py](file://src/kimi_cli/tools/file/grep.py)
- [read.py](file://src/kimi_cli/tools/file/read.py)
- [write.py](file://src/kimi_cli/tools/file/write.py)

## 实际调用示例

以下是这些工具在Agent提示词中的实际使用示例：

```yaml
# 示例1: 读取文件部分内容
- tool: ReadFile
  params:
    path: "/workspace/src/main.py"
    line_offset: 10
    n_lines: 20

# 示例2: 向文件追加内容
- tool: WriteFile
  params:
    path: "/workspace/logs/app.log"
    content: "2024-01-01 INFO: Application started\n"
    mode: "append"

# 示例3: 批量字符串替换
- tool: StrReplaceFile
  params:
    path: "/workspace/config/settings.json"
    edit:
      - old: '"debug": false'
        new: '"debug": true'
        replace_all: true
      - old: '"version": "1.0.0"'
        new: '"version": "1.1.0"'

# 示例4: 查找Python文件
- tool: Glob
  params:
    pattern: "*.py"
    directory: "/workspace/src"
    include_dirs: false

# 示例5: 搜索包含特定模式的文件
- tool: Grep
  params:
    pattern: "TODO:"
    path: "/workspace/src"
    output_mode: "files_with_matches"
    ignore_case: true
    type: "py"

# 示例6: 应用代码补丁
- tool: PatchFile
  params:
    path: "/workspace/src/utils.py"
    diff: |
      --- utils.py	2024-01-01 00:00:00.000000000 +0000
      +++ utils.py	2024-01-01 00:00:00.000000000 +0000
      @@ -10,7 +10,7 @@
       def calculate_total(items):
           total = 0
           for item in items:
      -        total += item['price']
      +        total += item.get('price', 0)
           return total
```

这些示例展示了如何在实际场景中使用这些工具，从简单的文件读写到复杂的代码修改。

**Section sources**
- [read.py](file://src/kimi_cli/tools/file/read.py)
- [write.py](file://src/kimi_cli/tools/file/write.py)
- [replace.py](file://src/kimi_cli/tools/file/replace.py)
- [glob.py](file://src/kimi_cli/tools/file/glob.py)
- [grep.py](file://src/kimi_cli/tools/file/grep.py)
- [patch.py](file://src/kimi_cli/tools/file/patch.py)

## 总结

本文档详细介绍了kimi-cli项目中的六个核心文件操作工具：ReadFile、WriteFile、StrReplaceFile、Glob、Grep和PatchFile。这些工具各司其职，共同构成了一个完整、安全、高效的文件操作生态系统。

**核心要点**：
- **功能明确**：每个工具都有清晰的功能定位，从文件读取到内容搜索再到精确修改。
- **安全优先**：通过审批机制确保所有文件修改操作都经过用户确认。
- **限制合理**：设置了合理的使用限制，防止资源滥用和性能问题。
- **协作强大**：工具间可以灵活组合，实现复杂的文件处理工作流。

通过合理使用这些工具，可以高效、安全地完成各种文件操作任务，同时保持对系统状态的完全控制。建议在实际使用中遵循最佳实践，充分利用工具的协作能力，同时严格遵守安全审批流程。

**Section sources**
- [read.py](file://src/kimi_cli/tools/file/read.py)
- [write.py](file://src/kimi_cli/tools/file/write.py)
- [replace.py](file://src/kimi_cli/tools/file/replace.py)
- [glob.py](file://src/kimi_cli/tools/file/glob.py)
- [grep.py](file://src/kimi_cli/tools/file/grep.py)
- [patch.py](file://src/kimi_cli/tools/file/patch.py)