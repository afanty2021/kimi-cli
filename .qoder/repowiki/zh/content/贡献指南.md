# 贡献指南

<cite>
**本文档中引用的文件**
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [README.md](file://README.md)
- [pyproject.toml](file://pyproject.toml)
- [Makefile](file://Makefile)
- [CHANGELOG.md](file://CHANGELOG.md)
- [AGENTS.md](file://AGENTS.md)
- [tests/conftest.py](file://tests/conftest.py)
- [tests/test_config.py](file://tests/test_config.py)
- [pyrightconfig.json](file://pyrightconfig.json)
</cite>

## 目录
1. [简介](#简介)
2. [欢迎贡献](#欢迎贡献)
3. [贡献类型](#贡献类型)
4. [贡献流程](#贡献流程)
5. [开发环境设置](#开发环境设置)
6. [代码质量标准](#代码质量标准)
7. [测试要求](#测试要求)
8. [代码审查标准](#代码审查标准)
9. [社区行为准则](#社区行为准则)
10. [常见问题解答](#常见问题解答)

## 简介

感谢您对 Kimi CLI 项目的兴趣！Kimi CLI 是一个创新的命令行智能代理工具，旨在帮助开发者完成软件开发任务和终端操作。我们欢迎所有形式的贡献，包括但不限于功能开发、文档改进、问题报告等。

本指南将帮助您了解如何有效地为 Kimi CLI 做出贡献，无论您是经验丰富的开发者还是初次接触开源项目的新手。

## 欢迎贡献

Kimi CLI 项目欢迎以下类型的贡献：

### 我们重视的贡献类型：
- **功能开发**：添加新工具、改进现有功能或增强用户体验
- **文档改进**：修复拼写错误、改进文档清晰度或添加使用示例
- **问题报告**：发现并报告 bug 或性能问题
- **代码优化**：重构代码以提高可读性或性能
- **测试增强**：添加新的测试用例或改进测试覆盖率
- **工具集成**：支持新的 MCP（模型上下文协议）服务器

### 我们的承诺：
- 为所有贡献者提供友好、包容的环境
- 及时反馈和沟通
- 尊重每个贡献的价值
- 提供学习和成长的机会

## 贡献类型

### 小型贡献（小于 100 行代码）
对于小型更改，您可以直接开始工作而无需事先讨论。这些通常包括：
- 文档修正
- 小的 bug 修复
- 用户界面微调
- 测试用例添加

### 大型贡献（100 行及以上代码）
对于重大变更，我们强烈建议在开始工作前与我们讨论：
- 新工具开发
- 核心架构变更
- 性能优化
- 新功能实现

**重要提示**：对于大型贡献，请通过 [创建问题](https://github.com/MoonshotAI/kimi-cli/issues) 或参与现有问题讨论来获得反馈。

## 贡献流程

### 第一步：Fork 仓库
1. 访问 [Kimi CLI GitHub 仓库](https://github.com/MoonshotAI/kimi-cli)
2. 点击右上角的 "Fork" 按钮创建您的副本
3. Fork 后，您将在 `https://github.com/YOUR_USERNAME/kimi-cli` 下拥有项目副本

### 第二步：克隆到本地
```bash
git clone https://github.com/YOUR_USERNAME/kimi-cli.git
cd kimi-cli
```

### 第三步：设置开发环境
```bash
# 准备开发环境
make prepare

# 安装开发依赖
uv sync --group dev
```

### 第四步：创建工作分支
```bash
# 创建新分支
git checkout -b feature/your-feature-name

# 或创建修复分支
git checkout -b fix/issue-description
```

### 第五步：进行开发
1. 使用推荐的编辑器（VS Code、PyCharm 等）
2. 遵循代码风格指南
3. 添加必要的测试
4. 更新相关文档

### 第六步：运行测试和检查
```bash
# 格式化代码
make format

# 运行代码检查
make check

# 运行测试
make test
```

### 第七步：提交更改
```bash
# 添加更改
git add .

# 提交更改
git commit -m "描述您的更改"

# 推送到您的 fork
git push origin feature/your-feature-name
```

### 第八步：创建 Pull Request
1. 在 GitHub 上导航到您的 fork
2. 点击 "New Pull Request"
3. 提供详细的 PR 描述
4. 关联相关问题（如果有）

## 开发环境设置

### 系统要求
- Python 3.13 或更高版本
- uv 包管理器（现代 Python 包管理器）
- Git 版本控制

### 快速开始
```bash
# 克隆仓库
git clone https://github.com/MoonshotAI/kimi-cli.git
cd kimi-cli

# 准备环境
make prepare

# 运行 Kimi CLI
uv run kimi
```

### 开发命令
项目提供了多个 Make 目标来简化开发流程：

| 命令 | 功能 | 用途 |
|------|------|------|
| `make prepare` | 安装依赖 | 初始化开发环境 |
| `make format` | 代码格式化 | 自动格式化 Python 代码 |
| `make check` | 代码检查 | 运行 linting 和类型检查 |
| `make test` | 运行测试 | 执行完整的测试套件 |
| `make build` | 构建可执行文件 | 使用 PyInstaller 构建独立可执行文件 |

### 项目结构
```
src/kimi_cli/
├── agents/          # 默认代理配置
├── soul/           # 核心代理执行逻辑
├── tools/          # 工具实现
│   ├── bash/       # Shell 命令执行
│   ├── file/       # 文件操作
│   ├── web/        # 网络搜索
│   └── task/       # 子代理任务
├── ui/             # 用户界面实现
└── utils/          # 工具函数
```

**章节来源**
- [Makefile](file://Makefile#L1-L37)
- [pyproject.toml](file://pyproject.toml#L1-L67)

## 代码质量标准

### 代码格式化
我们使用 [Ruff](https://docs.astral.sh/ruff/) 进行代码格式化和 linting：

```bash
# 自动修复格式问题
make format

# 检查格式但不修改
make check
```

### 类型检查
使用 [Pyright](https://microsoft.github.io/pyright/) 进行静态类型检查：

```bash
# 运行类型检查
uv run pyright
```

### 代码风格规则
我们采用以下 Ruff 规则集：

| 规则 | 描述 |
|------|------|
| E | pycodestyle 错误 |
| F | Pyflakes 检查 |
| UP | pyupgrade 自动升级 |
| B | flake8-bugbear 检查 |
| SIM | flake8-simplify 优化 |
| I | isort 导入排序 |

### 最大行长度
- **Python 代码**：100 字符
- **Markdown 文档**：不限制行长度

### 错误处理
- 使用特定的异常类型
- 正确的异常链传递
- 清晰的错误消息

**章节来源**
- [pyproject.toml](file://pyproject.toml#L49-L67)
- [pyrightconfig.json](file://pyrightconfig.json#L1-L24)

## 测试要求

### 测试框架
我们使用 [pytest](https://docs.pytest.org/) 进行测试，支持异步测试：

```bash
# 运行所有测试
make test

# 运行特定测试文件
uv run pytest tests/test_config.py -vv

# 运行 AI 测试
make ai-test
```

### 测试策略
1. **单元测试**：覆盖所有工具和核心组件
2. **集成测试**：端到端测试代理工作流
3. **模拟测试**：使用 Mock 提供商进行一致的测试

### 测试文件组织
```
tests/
├── test_*.py           # 单元测试
├── test_*_file.py      # 文件操作测试
├── test_task_subagents.py # 子代理测试
└── conftest.py         # 测试夹具
```

### 测试最佳实践
- 使用 pytest fixtures 提供测试数据
- 编写异步测试使用 `@pytest.mark.asyncio`
- 使用快照测试验证输出
- 测试边界条件和错误情况

**章节来源**
- [tests/conftest.py](file://tests/conftest.py#L1-L245)
- [tests/test_config.py](file://tests/test_config.py#L1-L40)

## 代码审查标准

### 审查重点
1. **功能正确性**：代码是否按预期工作
2. **代码质量**：遵循项目编码标准
3. **安全性**：避免安全漏洞
4. **性能**：不影响应用性能
5. **文档**：更新相关文档

### 审查流程
1. **自动检查**：CI/CD 系统自动运行测试和检查
2. **人工审查**：维护者审查代码变更
3. **反馈处理**：及时响应审查意见
4. **最终批准**：维护者批准合并

### 合并要求
- 所有测试必须通过
- 代码质量检查通过
- 至少一名维护者批准
- 无冲突的合并

### 大型变更处理
对于超过 100 行代码的变更：
1. 必须在开始工作前讨论
2. 提供详细的设计文档
3. 获得维护者同意
4. 分阶段提交以便于审查

**章节来源**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L9)

## 社区行为准则

### 我们的承诺
为了营造一个开放、友好的环境，我们承诺：
- 尊重每位贡献者
- 接受建设性反馈
- 以社区最佳利益行事
- 对所有人保持友善

### 可接受的行为
- 使用友好和包容的语言
- 尊重不同观点和经验
- 优雅地接受批评
- 专注于对社区最有利的事情
- 对其他社区成员表示同理心

### 不可接受的行为
- 使用性语言或图像
- 恶意攻击或人身攻击
- 公开或私下骚扰
- 发布他人私人信息
- 其他不专业行为

### 执行
违反行为准则的行为可通过联系维护者报告。项目团队将调查并采取适当措施。

## 常见问题解答

### Q: 如何报告 bug？
A: 请在 [GitHub Issues](https://github.com/MoonshotAI/kimi-cli/issues) 中创建新问题，包含：
- 清晰的问题描述
- 重现步骤
- 预期行为和实际行为
- 系统环境信息

### Q: 如何请求新功能？
A: 对于重大功能变更：
1. 先创建问题讨论
2. 描述用例和需求
3. 等待维护者反馈
4. 根据反馈准备 PR

### Q: 代码审查需要多久？
A: 通常情况下：
- 小型 PR：1-2 天
- 中型 PR：2-5 天
- 大型 PR：1-2 周

### Q: 如何获得帮助？
A: 
1. 查看 [README.md](file://README.md) 获取基本使用信息
2. 搜索现有 [Issues](https://github.com/MoonshotAI/kimi-cli/issues)
3. 创建新问题寻求帮助

### Q: 项目版本如何管理？
A: 项目使用语义化版本控制，详细历史可在 [CHANGELOG.md](file://CHANGELOG.md) 中查看。

**章节来源**
- [CHANGELOG.md](file://CHANGELOG.md#L1-L488)
- [README.md](file://README.md#L159-L162)

## 结语

感谢您考虑为 Kimi CLI 做出贡献！我们很高兴看到新面孔加入我们的社区。记住，每个贡献都很重要，无论大小。如果您有任何疑问或需要帮助，请随时联系我们。

让我们一起构建更好的开发工具，让编程变得更简单、更有趣！